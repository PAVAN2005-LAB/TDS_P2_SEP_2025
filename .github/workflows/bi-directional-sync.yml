name: Bi-Directional Repo Sync (FIXED)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */6 * * *' 

jobs:
  sync-hf-and-github:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push to GitHub

    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git and Set Environment Variables
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # We only need the authenticated URL for PULLING from HF
          # For PUSHING to HF, we'll use a safer direct push command below.
          echo "HF_REPO_URL_AUTH=https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}" >> $GITHUB_ENV
          echo "HF_REPO_URL_SAFE=https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}" >> $GITHUB_ENV
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}

      # --- 1. Pull Changes FROM Hugging Face to GitHub ---
      - name: Pull Changes from Hugging Face to Local Runner
        run: |
          echo "Syncing changes from Hugging Face..."
          # Clone HF repo into a temporary folder
          git clone --depth 1 $HF_REPO_URL_AUTH hf_temp
          
          # Move all contents (EXCEPT the .git folder)
          find hf_temp/ -maxdepth 1 -mindepth 1 -not -name '.git' -exec mv {} . \;
          
          # Remove the temporary clone directory
          rm -rf hf_temp

      # --- 2. Push Final State TO GitHub AND Hugging Face ---
      - name: Commit and Push to Both Remotes
        run: |
          # Use a more reliable check for changes
          if ! git diff --quiet; then
            echo "Changes detected. Committing and synchronizing."
            git add .
            git commit -m "Bi-Sync: Merged content from Hugging Face Space"
            
            # 1. Push to GitHub (origin) - Uses the standard GITHUB_TOKEN
            echo "Pushing final state to GitHub..."
            git push origin main
            
            # 2. Push to Hugging Face - Uses the secure, authenticated URL
            echo "Pushing final state to Hugging Face..."
            
            # Push using the token directly in the push command for better reliability
            git push "$HF_REPO_URL_SAFE" main --force --repo="https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}"
          else
            echo "No changes detected. Repositories are already in sync."
          fi
