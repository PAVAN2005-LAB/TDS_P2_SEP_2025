name: Bi-Directional Repo Sync

on:
  # This is the SAFEST trigger for bi-directional sync to avoid infinite loops.
  # You must manually trigger this from the Actions tab in GitHub.
  workflow_dispatch:
  
  # Optional: Uncomment to run on a schedule (e.g., every 6 hours)
  # schedule:
  #   - cron: '0 */6 * * *' 

jobs:
  sync-hf-and-github:
    runs-on: ubuntu-latest

    # Grant permissions to write back to the GitHub repo
    permissions:
      contents: write

    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          # Required to push back to GitHub's remote
          fetch-depth: 0

      - name: Configure Git and Set Environment Variables
        run: |
          # Configure Git user for commits
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # Construct the authenticated Hugging Face URL for cloning and pushing
          echo "HF_REPO_URL_AUTH=https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}" >> $GITHUB_ENV
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}

      # --- 1. Pull Changes FROM Hugging Face to GitHub ---
      - name: Pull Changes from Hugging Face to Local Runner
        run: |
          # Clone the HF repo into a temporary folder
          git clone --depth 1 $HF_REPO_URL_AUTH hf_temp
          
          # Use 'find' to move all contents (including dotfiles) EXCEPT the .git folder
          find hf_temp/ -maxdepth 1 -mindepth 1 -not -name '.git' -exec mv {} . \;
          
          # Remove the temporary clone directory
          rm -rf hf_temp

      # --- 2. Push Final State TO GitHub AND Hugging Face ---
      - name: Commit and Push to Both Remotes
        run: |
          # Check if any new or modified files were copied over from HF
          if git status --porcelain | grep .; then
            echo "Changes detected. Committing and synchronizing."
            git add .
            git commit -m "Bi-Sync: Merged content from Hugging Face Space"
            
            # 1. Push to GitHub (origin)
            echo "Pushing final state to GitHub..."
            git push origin main
            
            # 2. Add Hugging Face as a remote
            git remote add hf $HF_REPO_URL_AUTH
            
            # 3. Push to Hugging Face (hf)
            echo "Pushing final state to Hugging Face..."
            # --force is used here because the branches are independent; 
            # it ensures HF reflects the final state of the GitHub runner.
            git push hf main --force
          else
            echo "No changes detected. Repositories are already in sync."
          fi
