name: Bi-Directional Repo Sync (FINAL & FIXED)

on:
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

jobs:
  sync-hf-and-github:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Needed to push to GitHub

    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git and Set Environment Variables
        run: |
          # Configure Git user for commits
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # Construct the full authenticated URL with embedded secrets
          echo "HF_REPO_URL_AUTH=https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}" >> $GITHUB_ENV
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}

      # --- 1. Pull Changes FROM Hugging Face ---
      - name: Pull Changes from Hugging Face to Local Runner
        run: |
          echo "Syncing changes from Hugging Face..."
          # Clone HF repo into a temporary folder using the authenticated URL
          git clone --depth 1 $HF_REPO_URL_AUTH hf_temp
          
          # Use 'find' to move all contents (EXCEPT the .git folder)
          find hf_temp/ -maxdepth 1 -mindepth 1 -not -name '.git' -exec mv {} . \;
          
          # Remove the temporary clone directory
          rm-rf hf_temp

      # -------------------------------------------------------------
      # --- 2. Push Final State TO GitHub AND Hugging Face (FIXED)---
      # -------------------------------------------------------------
      - name: Commit and Push to Both Remotes (FIXED PUSHES)
        run: |
          # Check for changes in the runner's workspace
          if ! git diff --quiet; then
            echo "Changes detected. Committing and synchronizing."
            git add .
            git commit -m "Bi-Sync: Merged content from Hugging Face Space"
            
            # 1. Prepare to push to GitHub by pulling any new remote changes
            echo "Pulling latest changes from GitHub before push..."
            # git pull --rebase is used here to avoid creating unnecessary merge commits
            git pull --rebase origin main 
            
            # 2. Push to GitHub (origin)
            echo "Pushing final state to GitHub..."
            git push origin main
            
            # 3. Push to Hugging Face
            echo "Pushing final state to Hugging Face..."
            # Push using the full authenticated URL with --force to ensure sync
            git push "$HF_REPO_URL_AUTH" main --force
          else
            echo "No changes detected. Repositories are already in sync."
          fi
