name: Sync From Hugging Face to GitHub

on:
  # Allows you to run this workflow manually from the Actions tab in GitHub
  workflow_dispatch:
  # Optional: You can also set a schedule, e.g., run every day at midnight UTC
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  sync-hf-to-github:
    runs-on: ubuntu-latest

    # Grant the built-in GITHUB_TOKEN permissions to push to the repo
    permissions:
      contents: write

    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          # We need to fetch the full history to make sure we can push back
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Set Environment Variables
        run: |
          echo "HF_REPO_URL=https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_NAME }}" >> $GITHUB_ENV
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}

      - name: Clone Hugging Face Space
        run: |
          # Clone the HF repo into a temporary folder named 'hf_temp'
          git clone --depth 1 $HF_REPO_URL hf_temp

      - name: Copy Files and Clean Up
        run: |
          # Move all files (including hidden ones like .env or .gitignore) 
          # from the cloned HF repo (excluding its .git folder) to the root of the GH repo
          shopt -s dotglob
          mv hf_temp/* .
          shopt -u dotglob
          
          # Remove the temporary clone directory
          rm -rf hf_temp

      - name: Commit and Push to GitHub
        run: |
          # Check if there are any changes to commit
          if ! git diff --exit-code; then
            echo "No changes detected. Skipping commit."
          else
            echo "Changes detected. Committing and pushing."
            git add .
            git commit -m "Sync: Updated content from Hugging Face Space"
            
            # Use the GITHUB_TOKEN for authentication when pushing
            git push origin main
          fi
